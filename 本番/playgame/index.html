<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>じもすご - 地元ですごろく</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="../lib/TileLayer.GeoJSON.js"></script>
    <script src="../lib/turf.min.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #mapdiv {
            height: 90%;
            width: 95%;
        }

        #mapdiv {
            margin: 5%;
        }

        .leaflet-container {
            background: #fff;
        }

        .gsi-div-icon {
            background: none;
            white-space: nowrap;
            border: none;
        }

        #pano {
            float: left;
            height: 80%;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="mapdiv"></div>
    <button onclick="diceroll()">ダイスを振る</button>
    <div id="history"></div>
    <div id="pano"></div>

    <script>
        let url = new URL(window.location.href);
        let mapdata = JSON.parse(url.searchParams.get('mapdata'));

        //地理院地図レイヤ
        let pale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
            attribution: "地理院タイル", maxZoom: 18, opacity: 1
        });

        //始点、終点マーカーレイヤ
        let startlayer = L.geoJson({
            type: "FeatureCollection",
            features: [{
                type: "Feature",
                geometry: { "type": "Point", "coordinates": mapdata.start },
                properties: {}
            }]
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "../images/start.png",
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    })
                });
            }
        });

        let goallayer = L.geoJson({
            type: "FeatureCollection",
            features: [{
                type: "Feature",
                geometry: { "type": "Point", "coordinates": mapdata.goal },
                properties: {}
            }]
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "../images/goal.png",
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    })
                });
            }
        });

        let gamemaplayer = L.geoJson({
            type: "FeatureCollection",
            features: []
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "../images/point.png",
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    })
                });
            }
        });

        mapdata.map.forEach(i => {
            gamemaplayer.addData({
                type: "Feature",
                geometry: { "type": "Point", "coordinates": i },
                properties: {}
            })
        });

        let road_edge_layer = L.geoJson(null, {
            style: function () { return { "color": "#ffffff", "weight": 31, "opacity": 1, "lineCap": "butt", }; },
            clickable: false
        });
        let road_main_layer = L.geoJson(null, {
            style: function () { return { "color": "#808080", "weight": 21, "opacity": 1, "lineCap": "butt", }; },
            clickable: false
        });
        let road_center_line_layer = L.geoJson(null, {
            style: function () { return { "color": "#ffffff", "weight": 5, "opacity": 1, "lineCap": "butt", "dashArray": "10 9" }; },
            clickable: false
        });

        let f = {
            "type": "Feature",
            "geometry": {
                "type": "LineString",
                "coordinates": [mapdata.start, mapdata.map[0]]
            },
            "properties": {}
        }
        road_edge_layer.addData(f);
        road_main_layer.addData(f);
        road_center_line_layer.addData(f);
        for (let i = 0; i < mapdata.map.length - 1; i++) {
            f.geometry.coordinates = [mapdata.map[i], mapdata.map[i + 1]]
            road_edge_layer.addData(f);
            road_main_layer.addData(f);
            road_center_line_layer.addData(f);
        }
        f.geometry.coordinates = [mapdata.map[mapdata.map.length - 1], mapdata.goal]
        road_edge_layer.addData(f);
        road_main_layer.addData(f);
        road_center_line_layer.addData(f);

        let playerlayer = L.geoJson({
            type: "FeatureCollection",
            features: []
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng
                    // , {
                    //     icon: L.icon({
                    //         iconUrl: "./icon/human.png",
                    //         iconSize: [50, 50],
                    //         iconAnchor: [25, 30]
                    //     })
                    // }
                );
            }
        });

        let now = 0;
        let c = mapdata.start;
        playerlayer.addData({
            type: "Feature",
            geometry: { "type": "Point", "coordinates": c },
            properties: {}
        })
        function diceroll(e) {
            playerlayer.clearLayers();
            now += Math.floor(Math.random() * 7);
            if (now > mapdata.mapsize) {
                c = mapdata.goal;
            } else {
                c = mapdata.map[now - 1];
            }
            playerlayer.addData({
                type: "Feature",
                geometry: { "type": "Point", "coordinates": c },
                properties: {}
            })
            map.setView([c[1], c[0]]);
            panorama.setPosition({ lat: c[1], lng: c[0] });
        }

        let map = L.map("mapdiv", {
            center: [mapdata.start[1], mapdata.start[0]], zoom: 16, minZoom: 16, maxZoom: 18,
            layers: [pale, startlayer, goallayer, gamemaplayer, playerlayer, road_edge_layer, road_main_layer, road_center_line_layer]
        });
    </script>
    <script>
        const panoEle = document.getElementById('pano');
        var panorama = null;
        function initialize() {
            var location = { lat: 43.771179, lng: 142.368805 }//東京タワー
            // StreetView
            panorama = new google.maps.StreetViewPanorama(panoEle, {
                position: location,
                pov: {
                    heading: 34,
                    pitch: 10
                }
            });
        };
    </script>
    <script defer src="https://maps.googleapis.com/maps/api/js?key={ API_KEY }&callback=initialize"></script>

</body>

</html>