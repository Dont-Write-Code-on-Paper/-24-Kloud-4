<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>じもすご - 地元ですごろく</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="../lib/TileLayer.GeoJSON.js"></script>
    <script src="../lib/turf.min.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body {
            height: 100%;
            width: 100%;
        }

        .leaflet-container {
            background: #fff;
        }

        .gsi-div-icon {
            background: none;
            white-space: nowrap;
            border: none;
        }

        #pano {
            float: left;
            height: 100%;
            width: 60%;
        }

        #mapdiv {
            height: 50%;
            width: 40%;
            position: absolute;
            bottom: 0;
        }

        #info {
            float: left;
            height: 100%;
            width: 40%;
            background-color: beige;
        }

        #history {
            flex-basis: 60%;
            height: 38vh;
            width: 25vw;
            margin: 0 5px 10px 5px;
            overflow-y: scroll;
            border: 10px double #313131;
            border-radius: 20px;
            background-color: aliceblue;
        }

        #remainders {
            height: 22vh;
            margin-bottom: 10px;
            border: 10px double #313131;
            border-radius: 20px;
            background-color: aliceblue;
        }

        .rem {
            font-size: 35px;
            font-weight: bolder;
        }

        #remdisplay-red {
            Visibility: hidden;
            color: red;
        }

        #remdisplay-blue {
            Visibility: hidden;
            color: blue;
        }

        #remdisplay-green {
            Visibility: hidden;
            color: green;
        }

        #remdisplay-orange {
            Visibility: hidden;
            color: orange;
        }

        #dice {
            flex-basis: 40%;
            margin-left: 10px;
            margin-right: 5px;
        }

        
        #turn {
            font-family: "M PLUS Rounded 1c", sans-serif;
            text-align: center;
            color: red;
            font-size: 30px;
        }
        
        #column,
        #dice_info {
            display: flex;
            justify-content: space-between;
        }
        
        #dice_roll {
            flex-basis: 50%;
        }
        
        #dice_icon,
        #dice_button {
            width: 100%;
        }

        #dice_count {
            flex-basis: 50%;
            font-family: "M PLUS Rounded 1c", sans-serif;
            text-align: center;
            color: red;
        }

        #dice_count_number {
            height: 10vh;
            width: 7vw;
            font-size: 60px;
            font-weight: bold;
        }

        #dice_count_string {
            font-size: 12px;
        }

        #dicebutton {
            display: block;
            width: 150px;
            border-radius: 10px;
            margin: 20px 0;
        }


        /* ゴール演出 */

        #popup-background{
	        position: fixed; /* ブラウザの定位置に固定 */
	        background: rgba(0, 0, 0, 0.5); /* 背景色を半透明の黒色に */
	        width: 100%; /* 要素の横幅を画面全体に */
	        height: 100%; /* 要素の高さを画面全体に */
	        top: 0; /* 要素の固定位置をブラウザ最上部に合わせる */
	        left: 0; /* 要素の固定位置をブラウザ左側に合わせる */
	        z-index: 1000; /* 要素をコンテンツより前面に（要調整） */
        }
        
        
        #popup-switch {
            /* チェックボックスを非表示 */
            display: none;
        }
        
        #popup-content {
            /* ポップアップ本体 */
            display: inline-block;
            position: fixed;
            width: 75%;
            z-index: 1100;
            background: beige;
            border-radius: 20px;
            padding: 2%;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            
            /* ヌルっと出てくるアニメション */
            animation-name:fadeInAnime;
            animation-duration:3s;
            animation-fill-mode:forwards;
            opacity:0;
        }
        @keyframes fadeInAnime{
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        #popup-close {
            /* ポップアップ内の閉じるボタン */
            position: relative;
            display: inline-block;
            background: #09f;
            color: #fff;
            padding: 0 1em;
            border-radius: 3px;
            cursor: pointer;
            left: 50%;
            transform: translateX(-50%);
        }

        #popup-switch:not(:checked) ~ #popup-background, #popup-switch:not(:checked) ~ #popup-box {
            /* ポップアップ･透過背景を閉じる */
            display: none;
        }

        #winner {
            font-family: "M PLUS Rounded 1c", sans-serif;
            text-align: center;
            font-size: 42px;
        }
        
        #winner_icon{
            display: block;
            margin: 10px auto;
            object-fit: cover;
            width: 10%;
        }
    </style>
</head>

<body>
    <div id="pano"></div>
    <!-- panoがstreetviewの入っているdiv要素です。これもmapdivと同じように余白類調整してください。 -->
    <!-- background-color指定しているのはどのdiv要素がどこにいるのかを可視化するためで、デザイン的な意図はないです。 -->
    <div id="info">
        <div id="turn">プレイヤー1の番です。</div>
        <div id="column">
            <div id="dice">
                <div id="remainders">
                    <div id="remdisplay-red">プレイヤー1 残り<span class="rem" id="redrem">1</span>マス</div>
                    <div id="remdisplay-blue">プレイヤー2 残り<span class="rem" id="bluerem">2</span>マス</div>
                    <div id="remdisplay-green">プレイヤー3 残り<span class="rem" id="greenrem">3</span>マス</div>
                    <div id="remdisplay-orange">プレイヤー4 残り<span class="rem" id="orangerem">4</span>マス</div>
                </div>
                <div id="dice_info"> 
                    <div id="dice_roll">
                        <img src="../images/dices/dice_1.png" id="dice_icon">
                        <button onclick="diceroll()" id="dice_button">ダイスを振る</button>
                    </div>
                    <div id="dice_count">
                        <div id="dice_count_number">-</div>
                        <div id="dice_count_string">マス進む</div>
                    </div>
                </div>
            </div>
            <div id="history">
            </div>
        </div>
        <div id="mapdiv"></div>
        
    </div>


    <input type="checkbox" id="popup-switch" />
    <div id="popup-background"></div>
    <div id="popup-box">
        <div id="popup-content">
            <div id="winner">playernameの勝利!</div>
            <img src="../images/players/blue.png" id="winner_icon">
            <label for="popup-switch" id="popup-close">閉じる</label>
        </div>
    </div>


    <script>
        let url = new URL(window.location.href);
        let mapdata = JSON.parse(url.searchParams.get('mapdata'));
        console.log(mapdata);

        //地理院地図レイヤ
        let pale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
            attribution: "地理院タイル", maxZoom: 18, opacity: 1
        });

        //始点、終点マーカーレイヤ
        let startlayer = L.geoJson({
            type: "FeatureCollection",
            features: [{
                type: "Feature",
                geometry: { "type": "Point", "coordinates": mapdata.start },
                properties: {}
            }]
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "../images/points/start.png",
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    })
                });
            }
        });

        let goallayer = L.geoJson({
            type: "FeatureCollection",
            features: [{
                type: "Feature",
                geometry: { "type": "Point", "coordinates": mapdata.goal },
                properties: {}
            }]
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "../images/points/goal.png",
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    })
                });
            }
        });

        let gamemaplayer = L.geoJson({
            type: "FeatureCollection",
            features: []
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "../images/points/point.png",
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    })
                });
            }
        });

        mapdata.map.forEach(i => {
            gamemaplayer.addData({
                type: "Feature",
                geometry: { "type": "Point", "coordinates": i },
                properties: {}
            })
        });

        let road_edge_layer = L.geoJson(null, {
            style: function () { return { "color": "#ffffff", "weight": 31, "opacity": 1, }; },
            clickable: false
        });
        let road_main_layer = L.geoJson(null, {
            style: function () { return { "color": "#808080", "weight": 21, "opacity": 1, }; },
            clickable: false
        });
        let road_center_line_layer = L.geoJson(null, {
            style: function () { return { "color": "#ffffff", "weight": 5, "opacity": 1, "dashArray": "10 9" }; },
            clickable: false
        });

        mapdata.path.forEach(i => {
            road_edge_layer.addData(i);
            road_main_layer.addData(i);
            road_center_line_layer.addData(i);
        });

        let redplayerlayer = L.geoJson({
            type: "FeatureCollection",
            features: []
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "../images/players/red.png",
                        iconSize: [30, 50],
                        iconAnchor: [12, 40]
                    })
                });
            }
        });
        let greenplayerlayer = L.geoJson({
            type: "FeatureCollection",
            features: []
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "../images/players/green.png",
                        iconSize: [30, 50],
                        iconAnchor: [16, 40]
                    })
                });
            }
        });
        let blueplayerlayer = L.geoJson({
            type: "FeatureCollection",
            features: []
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "../images/players/blue.png",
                        iconSize: [30, 50],
                        iconAnchor: [14, 38]
                    })
                });
            }
        });
        let orangeplayerlayer = L.geoJson({
            type: "FeatureCollection",
            features: []
        }, {
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: "../images/players/yellow.png",
                        iconSize: [30, 50],
                        iconAnchor: [18, 38]
                    })
                });
            }
        });

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        };

        let players = [redplayerlayer, blueplayerlayer, greenplayerlayer, orangeplayerlayer];
        let playerscolor = ["red", "blue", "green", "orange"];
        let remdisplay_id = ["remdisplay-red", "remdisplay-blue", "remdisplay-green", "remdisplay-orange"];
        let rem_id = ["redrem", "bluerem", "greenrem", "orangerem"];
        let remdisplays = [];
        let pos = [0, 0, 0, 0];
        let c = mapdata.start;
        for (let i = 0; i < mapdata.playernum; i++) {
            document.getElementById(remdisplay_id[i]).style.visibility = "visible";
            remdisplays.push(document.getElementById(rem_id[i]));
            remdisplays[i].innerText = mapdata.map.length + 1;
            players[i].addData({
                type: "Feature",
                geometry: { "type": "Point", "coordinates": c },
                properties: {}
            })
        }

        let turn = 0;
        let turndisplay = document.getElementById("turn");
        let winnerdisplay = document.getElementById("winner");
        let switchwinnerdisplay = document.getElementById("popup-switch");
        let winnericon = document.getElementById("winner_icon");
        let winconpath = ["../images/winnericon/red.png", "../images/winnericon/blue.png", "../images/winnericon/green.png", "../images/winnericon/yellow.png"];
        let history = document.getElementById("history");
        let diceicon = document.getElementById("dice_icon");
        let diconpath = ["../images/dices/dice_1.png", "../images/dices/dice_2.png", "../images/dices/dice_3.png", "../images/dices/dice_4.png", "../images/dices/dice_5.png", "../images/dices/dice_6.png"]
        let stepcolor = document.getElementById("dice_count");
        let stepnum = document.getElementById("dice_count_number");
        mapdata.map.push(mapdata.goal);
        async function diceroll(e) {
            for (let i = 0; i < 10; i++) {
                diceicon.src = diconpath[Math.floor(Math.random() * 6)];
                await sleep(50);
            }

            let n = Math.floor(Math.random() * 6) + 1
            history.innerHTML += "プレイヤー" + (turn + 1) + "が" + n + "を出しました。<br>";
            stepcolor.style.color = playerscolor[turn];
            stepnum.innerHTML = n;
            diceicon.src = diconpath[n - 1];
            await sleep(500);

            for (let i = 1; i <= n; i++) {
                c = mapdata.map[++pos[turn] - 1];
                panorama.setPosition({ lat: c[1], lng: c[0] });
                remdisplays[turn].innerText = (mapdata.map.length - pos[turn]);
                players[turn].clearLayers();
                players[turn].addData({
                    type: "Feature",
                    geometry: { "type": "Point", "coordinates": c },
                    properties: {}
                })
                stepnum.innerHTML = n-i;
                map.setView([c[1], c[0]]);
                if (pos[turn] > mapdata.map.length - 1) {
                    history.innerHTML += "プレイヤー" + (turn + 1) + "がゴールしました。<br>";
                    winnerdisplay.innerHTML = "プレイヤー" + (turn + 1) + "の勝利！ <br>";
                    winnericon.src = winconpath[turn];
                    switchwinnerdisplay.checked = true;
                    break;
                }
                await sleep(1500);
            }

            turn = (turn + 1) % mapdata.playernum;
            turndisplay.innerText = "プレイヤー" + (turn + 1) + "の番です。";
            turndisplay.style.color = playerscolor[turn];
        }

        let map = L.map("mapdiv", {
            center: [mapdata.start[1], mapdata.start[0]], zoom: 16, minZoom: 16, maxZoom: 18,
            layers: [pale, startlayer, goallayer, gamemaplayer, redplayerlayer, blueplayerlayer, greenplayerlayer, orangeplayerlayer, road_edge_layer, road_main_layer, /*road_center_line_layer*/]
        });

        const panoEle = document.getElementById('pano');
        var panorama = null;
        function initialize() {
            panorama = new google.maps.StreetViewPanorama(panoEle, {
                position: { lat: mapdata.start[1], lng: mapdata.start[0] },
                pov: {
                    heading: 34,
                    pitch: 10
                }
            });
        };
    </script>
    <script defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9iCslOuoDeHlj7AFlPuZDda7Xuo26VcA&callback=initialize"></script>

</body>

</html>